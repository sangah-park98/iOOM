var fundSettleHot;
var fundSettleDetailHot;
var fundSettleSettings;
var fundSettlePopupSettings;
var fundSettleIndex = 9999;
var fundSettleScrollTp = true;
var globalSData = {};
var partnCmpnyNm = "";
var colCount = 0;
var excelUploadHot;
var customDropdown = [];
var forwordDropdown = [];
var transportationDropdown = [];
var warehouseDropdown = [];
var PremiumDropdown = [];
var feeDropdown = [];
var masterDropdown = [];

$( document ).ready(function() {
		
	  customDropdown = Object.entries(customsList).map(([key, value]) => 
	    value ? `${key}` : key 
	  );
	   forwordDropdown = Object.entries(forwordList).map(([key, value]) => 
	    value ? `${key}` : key 
	  );
	   transportationDropdown = Object.entries(transportationList).map(([key, value]) => 
	    value ? `${key}` : key 
	  );
	   PremiumDropdown = Object.entries(PremiumList).map(([key, value]) => 
	    value ? `${key}` : key 
	  );
	   warehouseDropdown = Object.entries(warehouseList).map(([key, value]) => 
	    value ? `${key}` : key 
	  );
	   
	  feeDropdown = Object.entries(feeList).map(([key, value]) => 
	    value ? `${key}` : key 
	  );
	   
	  masterDropdown = Object.entries(masterList).map(([key, value]) => 
	    value ? `${key}` : key 
	  );
	   
	
		
	  //ë‹¬ë ¥ ì‚¬ìš©ì‹œ ë°˜ë“œì‹œ ë„£ì–´ì£¼ì„¸ìš”.
      $('.band-calendar').each(function(){ regCal(this) ;})
	  //ìº˜ë¦°ë” í¬ë§·
      $('.datepicker').datepicker("option","dateFormat",calFormat);

	  	var date = new Date();
		var month = date.getMonth();
		var dayday = date.getDate();
		var day = date.getDay();
		
		var today = new Date().toISOString().substring(0,10);
		var mtoday = new Date(new Date().setDate(dayday - day)).toISOString().substring(0,10);
	  
	  $("#fundSettle_srch2").val(today);
	  $("#fundSettle_srch3").val(today);
	  
	  var fundSettleElement = document.querySelector('#fundSettleTable');
	  var fundSettleElementContainer = fundSettleElement.parentNode;
	  fundSettleHot = new Handsontable(fundSettleElement, fundSettleSettings);
	  
	  /*var fundSettlePopupElement = document.querySelector('#fundSettlePopupTable');
	  var fundSettlePopupElementContainer = fundSettlePopupElement.parentNode;
	  fundSettlePopupSettings = fn_handsonGridfundSettlePopupOption();
	  fundSettlePopupHot = new Handsontable(fundSettlePopupElement, fundSettlePopupSettings);*/
	  var impViewListPopupElement = document.querySelector('#fundSettlePopupTable');
	  var impViewListPopupElementContainer = impViewListPopupElement.parentNode;
	  impViewListPopupSettings = fn_handsonGridImpViewListPopupOption();
	  fundSettleDetailHot = new Handsontable(impViewListPopupElement, impViewListPopupSettings);

	  $("#fundSettle_div1").show();
	  $("#fundSettle_div2").show();
	  $("#fundSettle_div3").show();
	  $("#fundSettle_div4").show();

	  // 1ï¸ ì´ˆê¸° ê°’ ê°•ì œ ì„¤ì • (01 & read ê¸°ë³¸ ì„ íƒ)
	    $("input:radio[name=fundSettle_srch1][value='01']").prop("checked", true);
	    $("input:radio[name=fundSettleType][value='read']").prop("checked", true);

	    // 2ï¸ ê°•ì œë¡œ change ì´ë²¤íŠ¸ ì‹¤í–‰ (ì´ˆê¸° ìƒíƒœì—ì„œë„ í•¨ìˆ˜ ì‹¤í–‰)
	    $("input:radio[name=fundSettle_srch1]:checked").trigger("change");
	    $("input:radio[name=fundSettleType]:checked").trigger("change");

	    //scroll ì´ë²¤íŠ¸
	    fn_calculateasEventReg();
	  
	  $("#fundSettleTextView").text("ì „ì²´");
	  $("#fundSettleTextView").prepend('<i class="fa-duotone fa-feather text-primary-900"></i>'); 
	  
	  
});
/** ì´ë²¤íŠ¸ Start **/

$(document).mousedown(function(e){	
	if(e.target.name == "fundSettle1_date" || e.target.name == "fundSettle2_date"){
		if($(".calendar-popup-container").hasClass("calendar-popup-container_active")){
			return;
		}
		$(".calendar-popup-container").remove();
		$('.band-calendar').each(function(){ regCal(this);});
	}else{
		if($(".calendar-popup-container").hasClass("calendar-popup-container_active")){
			$(".calendar-popup-container").attr("class", "calendar-popup-container");
		}	
	}
});

// 3ï¸`fundSettle_srch1` ë³€ê²½ ê°ì§€
$(document).on("change", "input:radio[name=fundSettle_srch1]", function () {
    fn_changeFundSettleView($(this).val());
});

// 4ï¸ `fundSettleType` ë³€ê²½ ê°ì§€
$(document).on("change", "input:radio[name=fundSettleType]", function () {
    fn_changeFundSettleView($("input:radio[name=fundSettle_srch1]:checked").val());
});


function fn_calculChgDate1() {
	  var date = new Date();
	  var month = date.getMonth();
	  var dayday = date.getDate();
	  var day = date.getDay();
	  
	  var today = new Date().toISOString().substring(0,10);
	  var mtoday = new Date(new Date().setMonth(month - 1)).toISOString().substring(0,10);
	  
	  $("#fundSettle_srch2").val(today);
	  $("#fundSettle_srch3").val(today);
}

function fn_calculChgDate2() {
	var date = new Date();
	var month = date.getMonth();
	var dayday = date.getDate();
	var day = date.getDay();
	
	var today = new Date().toISOString().substring(0,10);
	var mtoday = new Date(new Date().setDate(dayday - day)).toISOString().substring(0,10);
	
	$("#fundSettle_srch2").val(mtoday);
	$("#fundSettle_srch3").val(today);
}
function fn_calculChgDate3() {
	var date = new Date();
	var month = date.getMonth();
	var dayday = date.getDate();
	var day = date.getDay();
	
	var today = new Date().toISOString().substring(0,10);
	var mtoday = new Date(new Date().setDate(dayday - dayday + 1)).toISOString().substring(0,10);
	
	$("#fundSettle_srch2").val(mtoday);
	$("#fundSettle_srch3").val(today);
}
function fn_calculChgDate4() {
	var date = new Date();
	var month = date.getMonth();
	var dayday = date.getDate();
	var day = date.getDay();
	
	  var startDt = new Date();
	  startDt.setDate(1);
	Â  startDt.setMonth(startDt.getMonth() - 1);

	Â  var endDt = new Date();
	Â  endDt.setMonth(endDt.getMonth(), 1);
	Â  endDt.setDate(endDt.getDate() - 1);
	
	var today = startDt.toISOString().substring(0,10);
	var mtoday = endDt.toISOString().substring(0,10);
	
	$("#fundSettle_srch2").val(today);
	$("#fundSettle_srch3").val(mtoday);
}

//ì •ë ¬í•­ëª©
/*$("select[name=alignImportView]").change(function(){
	  fn_searchImportView();
});
*/
function fn_setCalculView(){
	var sData = {};
	sData["srch1"] = $("input:radio[name=fundSettle_srch1]:checked").val(); //srch1: ê²€ìƒ‰êµ¬ë¶„
	sData["srch2"] = $("input[name=fundSettle1_date]").val(); // srch7: ì‹ ê³ ì¼ì ì²˜ìŒ
	sData["srch3"] = $("input[name=fundSettle2_date]").val(); // srch8: ì‹ ê³ ì¼ì ë
	sData["srch6"] = $("#fundSettle_srch6").val(); //ì‹ ê³ ë²ˆí˜¸
	sData["srch7"] = $("#fundSettle_srch7").val(); //blë²ˆí˜¸
	sData["srch8"] = $("#fundSettle_srch8").val(); //ì½”ë“œ
	sData["srch9"] = $("#fundSettle_srch9").val(); //ì´ë¦„
	sData["srch10"] = $("input:radio[name=fundSettleType]:checked").val(); //ì½ê¸° í¸ì§‘ ë“±ë¡
	sData["srch33"] = $("#fundSettle_day option:selected").val(); // srch33: ì‹ ê³ ì¼ì select
	sData["pageIndex"] = fundSettleIndex;
	sData["recordCountPerPage"] = $("#fundSettlePageCnt option:selected").val();
	
	// console.log(sData);
	
	return sData;
};




//ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
function fn_searchFundSettleViewInfo(){
	fundSettleIndex = 0;
	
	var sData = fn_setCalculView();
	var radioTp = $("input:radio[name=fundSettle_srch1]:checked").val();
	var tableType = $("input:radio[name=fundSettleType]:checked").val();
	if(radioTp == '01'){
		//ìê¸ˆì •ì‚°
		$.ajax({
			type : "POST",
			url : "/rpt/selectfundSettle.do",
			data : sData,
			beforeSend : function(xmlHttpRequest){
				xmlHttpRequest.setRequestHeader("AJAX", "true");
			},
			dataType: "json",
	        success : function(data) {
	        	fundSettleHot.loadData([]);
	        	 var totalCount = 0;
	             if (data.resultList && data.resultList.length > 0) {
	                 totalCount = data.resultList[0].cnt;
	             }
	        	$("#fundSettleCnt").text(totalCount); //ê²€ìƒ‰ê²°ê³¼ ì´ ê°¯ìˆ˜
	        	fundSettleHot.loadData(data.resultList);
	        	fn_loading(false);
	        },
	        error : function(e, textStatus, errorThrown) {
	        	if(e.status == 400){
	        		alert("Your request is up. Please log back in if you wish continue");
	        		location.href = document.referrer;
	        	} else {
		        	console.log(errorThrown);
		        	alert(msgSearchError);
	        	}
	        }
		});
	}else if(radioTp == '02'){
		//ë§ˆìŠ¤í„° ê´€ë¦¬
		$.ajax({
			type : "POST",
			url : "/rpt/selectMasterInfo.do",
			data : sData,
			beforeSend : function(xmlHttpRequest){
				xmlHttpRequest.setRequestHeader("AJAX", "true");
			},
			dataType: "json",
	        success : function(data) {
	        	
	         var totalCount = data.resultList[0].cnt; 
	        	$("#fundSettleCnt").text(totalCount); //ê²€ìƒ‰ê²°ê³¼ ì´ ê°¯ìˆ˜
	        	fundSettleHot.loadData([]);
	        	fundSettleHot.loadData(data.resultList);
	        	fn_loading(false);
	        },
	        error : function(e, textStatus, errorThrown) {
	        	if(e.status == 400){
	        		alert("Your request is up. Please log back in if you wish continue");
	        		location.href = document.referrer;
	        	} else {
		        	console.log(errorThrown);
		        	alert(msgSearchError);
	        	}
	        }
		});
	}
	
};



//ë¹„ìš©ì²´í¬ë°•ìŠ¤ 
function fn_CalculAllClick(){
	var check = "" ;
	var changeArr = [];
	if ( $("#id_checkCalculAll").prop("checked") == false) {
		check = "yes" ;
	} else {
		check = "no" ;
	}

	var data = fundSettleHot.getData();

	for(var i=0; i< data.length; i++){
		changeArr.push([i,0,check])
	}
	fundSettleHot.setDataAtCell(changeArr);
	if(check == "yes"){
		$("#id_checkCalculAll").prop("checked", true);
	} else {
		$("#id_checkCalculAll").prop("checked", false);
	}
}

//í¬ì›Œë”ì²´í¬ë°•ìŠ¤ 
function fn_ForwardAllClick(){
	var check = "" ;
	var changeArr = [];
	if ( $("#id_checkForwardAll").prop("checked") == false) {
		check = "yes" ;
	} else {
		check = "no" ;
	}

	var data = calculateDetailHot.getData();

	for(var i=0; i< data.length; i++){
		changeArr.push([i,0,check])
	}
	calculateDetailHot.setDataAtCell(changeArr);
	if(check == "yes"){
		$("#id_checkForwardAll").prop("checked", true);
	} else {
		$("#id_checkForwardAll").prop("checked", false);
	}
}


//row ìˆ˜
$("select[name=fundSettlePageCnt]").change(function(){
	fn_searchFundSettleViewInfo();
});


// ìŠ¤í¬ë¡¤í•  ë•Œ í–‰ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ ë¡œë“œë  ìˆ˜ ìˆê²Œ í•˜ëŠ” í•¨ìˆ˜
function fn_calculateasEventReg(){
 $("#fundSettleTable .wtHolder").scroll(function(){
	  	  var scrollTop = $("#fundSettleTable .wtHolder").scrollTop();
	  	  var countPerPage = $("#fundSettlePageCnt option:selected").val();
	  	  var rowHeight = fundSettleHot.getRowHeight();
	  	  var addCnt = 727;
	  	  if(countPerPage == "50"){
	  		  addCnt = 727;
	  	  }else if(countPerPage == "100"){
	  		  addCnt = 2040;
	  	  }else if(countPerPage == "200"){
	  		  addCnt = 3290;
	  	  }else if(countPerPage == "500"){
	  		  addCnt = 4540;
	  	  }
	  	if(fundSettleScrollTp && fundSettleIndex != 9999 && scrollTop >= (countPerPage * fundSettleIndex * rowHeight) + addCnt){
	  		fn_fundSettleScroll();
	  	  }
	  });

}


//ìŠ¤í¬ë¡¤
function fn_fundSettleScroll(){
	if( $("input[name=calculateType]:checked").val() == "enrol")
		return;
	
	fn_loading(true);
	fundSettleScrollTp = false;
	fundSettleIndex++;
	
	var sData = fn_setCalculView();
	var radioTp = $("input:radio[name=fundSettle_srch1]:checked").val();
	var tableType = $("input:radio[name=fundSettleType]:checked").val();

	if(radioTp == '01'){
		$.ajax({
		type : "POST",
		url : "/rpt/selectfundSettle.do",
		data : sData,
		beforeSend : function(xmlHttpRequest){
			xmlHttpRequest.setRequestHeader("AJAX", "true");
		},
		dataType: "json",
        success : function(data) {
        	var getData = fundSettleHot.getSourceData();
        	var meargeJson = getData.concat(data.resultList);
        	fundSettleHot.loadData(meargeJson);
        	fundSettleScrollTp = true;
        	fn_loading(false);
        },
        error : function(e, textStatus, errorThrown) {
        	if(e.status == 400){
        		alert("Your request is up. Please log back in if you wish continue");
        		location.href = document.referrer;
        	} else {
	        	console.log(errorThrown);
	        	alert(msgSearchError);
        	}
        }
	});
	}else if(radioTp == '02'){
		//ë§ˆìŠ¤í„° ê´€ë¦¬
		$.ajax({
			type : "POST",
			url : "/rpt/selectMasterInfo.do",
			data : sData,
			beforeSend : function(xmlHttpRequest){
				xmlHttpRequest.setRequestHeader("AJAX", "true");
			},
			dataType: "json",
	        success : function(data) {
	        	var getData = fundSettleHot.getSourceData();
	        	var meargeJson = getData.concat(data.resultList);
	        	fundSettleHot.loadData(meargeJson);
	        	fundSettleScrollTp = true;
	        	fn_loading(false);
	        },
	        error : function(e, textStatus, errorThrown) {
	        	if(e.status == 400){
	        		alert("Your request is up. Please log back in if you wish continue");
	        		location.href = document.referrer;
	        	} else {
		        	console.log(errorThrown);
		        	alert(msgSearchError);
	        	}
	        }
		});
	}
}


//Popup í…Œì´ë¸” ìŠ¤í¬ë¡¤
function calculateUseEventReg(){
	$("#popUsedTable .wtHolder").scroll(function(){
	  fn_popUsedStories(row, col)
	  var data = exportViewHot.getSourceData();
	  var scrollTop = $("#popUsedTable .wtHolder").scrollTop();
	  var countPerPage = 50;
	  var rowHeight = jdgmntUsageHot.getRowHeight();
	  var addCnt = 790;

//	  var addCnt = 790;
//	  if(countPerPage == "50"){
//		  addCnt = 790;
//	  }else if(countPerPage == "100"){
//		  addCnt = 2040;
//	  }else if(countPerPage == "200"){
//		  addCnt = 3290;
//	  }else if(countPerPage == "500"){
//		  addCnt = 4540;
//	  }

	  if(calculatePopScrollTp && fundSettleIndex != 9999 && scrollTop >= (countPerPage * fundSettleIndex * rowHeight) + addCnt){
		  fn_calculatePopScroll(data[row]);
	  }
});

}


function enterkey() {
	if (window.event.keyCode == 13) {
		fn_searchFundSettleViewInfo();
    }
}


//ê²€ìƒ‰ì¡°ê±´ ì´ˆê¸°í™”
function fn_clearfundSettleView(){
	
	var date = new Date();
	var month = date.getMonth();
	var dayday = date.getDate();
	  
	var today = new Date().toISOString().substring(0,10);
	var mtoday = new Date(new Date().setDate(dayday - 6)).toISOString().substring(0,10);
	
	$("#fundSettle_srch2").val(mtoday);
	$("#fundSettle_srch3").val(today);
};


//í…Œì´ë¸” ì»¬ëŸ¼
function fn_fundSettleTableCol(){
	
	var itemPkNoneEdit = function(instance, td, row, col, prop, value, cellProperties) {
	    // Handsontable ê¸°ë³¸ ì…€ ìŠ¤íƒ€ì¼ ì ìš©
	    Handsontable.renderers.TextRenderer.apply(this, arguments);
	}
	var tableType = $("input:radio[name=fundSettleType]:checked").val();
	var radioTp = $("input:radio[name=fundSettle_srch1]:checked").val();
	
	var fundSettleDetailRender = function(instance, td, row, col, prop, value, cellProperties) {
		$(td).empty();
		
		 // ë¶€ëª¨ ìš”ì†Œë¥¼ Flexboxë¡œ ì •ë ¬
	    $(td).css({
	        "display": "flex",
	        "justify-content": "center",
	        "align-items": "center"
	    });
		
	    if (value != '' && value != null) {
	        var $detailButton = $('<i class="fas fa-search search-icon" style="cursor:pointer; margin-right: 5px;" onclick="fn_fundSettleDetailList('+row+','+col+')"></i>');
	        $(td).append($detailButton);
	    }

	    // ê°’ ì¶”ê°€
	    if (value != null) {
	        $(td).append($('<span>').text(value));
	    }
	};
	
		this.fundSettleCol =  
			(tableType == "read" && radioTp == "02") ?[
			{data : 'seq', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'grpCd', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'cmmnCd', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'cmmnNm', className : "htCenter",wordWrap: false, width: 150,  readOnly:true},
			{data : 'delYn', className : "htCenter",wordWrap: false,width: 80,  readOnly:true}
			] :
			((tableType == "edit" || tableType == "enrol") && radioTp == "02") ?[
			{data : 'seq', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'grpCd', className : "htCenter",wordWrap: false, width: 150},
			{data : 'cmmnCd', className : "htCenter",wordWrap: false, width: 150},
			{data : 'cmmnNm', className : "htCenter",wordWrap: false, width: 150},
			{data : 'delYn',  type: 'dropdown', source: ['Y', 'N'], className : "htCenter",wordWrap: false,width: 80}
			] : 
			(radioTp == "01" && tableType == "read") ?[
			{data : 'checkBox', type : 'text', className : "htCenter", width: 60, type: 'checkbox', checkedTemplate: 'yes', uncheckedTemplate: 'no', readOnly:false},
			{data : 'hawb', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'rptNo', className : "htCenter",wordWrap: false, width: 150, readOnly:true,renderer : fundSettleDetailRender},
			{data : 'tradeComNm', className : "htCenter",wordWrap: false, width: 180, readOnly:true},
			{data : 'singoDt', className : "htCenter",wordWrap: false, width: 100, readOnly:true},
			{data : 'suriDt', className : "htCenter",wordWrap: false, width: 100, readOnly:true},
			{data : 'frKey', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'etc', className : "htCenter",wordWrap: false, width: 180, readOnly:true},
			{data : 'deadlineYn', className : "htCenter",wordWrap: false,  readOnly:true},
			]:(radioTp == "01" && tableType == "edit") ?[
			{data : 'checkBox', type : 'text', className : "htCenter", width: 60, readOnly:true, type: 'checkbox', checkedTemplate: 'yes', uncheckedTemplate: 'no', readOnly:false},
			{data : 'hawb', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'rptNo', className : "htCenter",wordWrap: false, width: 150,renderer : fundSettleDetailRender, readOnly:true},
			{data : 'tradeComNm', className : "htCenter",wordWrap: false, width: 180, readOnly:true},
			{data : 'singoDt', className : "htCenter",wordWrap: false, width: 100, readOnly:true},
			{data : 'suriDt', className : "htCenter",wordWrap: false, width: 100, readOnly:true},
			{data : 'frKey', className : "htCenter",wordWrap: false, width: 150, readOnly:true},
			{data : 'etc', className : "htCenter",wordWrap: false, width: 180},
			{data : 'deadlineYn', className : "htCenter",wordWrap: false, type: 'dropdown',source: ['Y', 'N']},
			]:[];
}


//í…Œì´ë¸” í—¤ë”
function fn_fundSettleTableHeader(){
	var tableType = $("input:radio[name=fundSettleType]:checked").val();
	var radioTp = $("input:radio[name=fundSettle_srch1]:checked").val(); 
			this.fundSettleHeader =( radioTp == "02")? [
				"seq","êµ¬ë¶„","ì½”ë“œ","ì´ë¦„","ì‚­ì œì—¬ë¶€"
				]:[
					"","B/Lë²ˆí˜¸","ì‹ ê³ ë²ˆí˜¸","ë‚©ì„¸ì˜ë¬´ì","ì‹ ê³ ì¼ì","ìˆ˜ë¦¬ì¼ì","frKey","ê¸°íƒ€ì‚¬í•­","ë§ˆê°ì—¬ë¶€"
				]; 
	
}

//í…Œì´ë¸” íˆë“ ì»¬ëŸ¼
function fn_fundSettleTableHidden(){
	var tableType = $("input:radio[name=fundSettleType]:checked").val();
	var radioTp = $("input:radio[name=fundSettle_srch1]:checked").val(); 
	if(radioTp == '02'){
		this.fundSettleHidden = [0];
	}else  if(radioTp == '01' && tableType == 'read'){
		this.fundSettleHidden = [6];
	}else if(radioTp == '01' && tableType == 'edit'){
		this.fundSettleHidden = [0,6];
	}
	
}

function fn_fundSettleDetailList(row, col){
	var data = fundSettleHot.getSourceDataAtRow(row);
	

	
$("#fundSettleDetailtPopUp").modal("show");
	
	var rptNoTitle = "ì‹ ê³ ë²ˆí˜¸: " + data.rptNo;
	var blNoTitle = "BLë²ˆí˜¸: " + data.hawb;
    
    var fundSettleDetailTitle = document.querySelector('.modal-content .fundSettleModal-title span');
    fundSettleDetailTitle.textContent = rptNoTitle+"  /  "+blNoTitle;
	
    globalSData = {
            "srch1": data["rptNo"].replace(/-/g, ''),
            "srch2": data["hawb"],
            "srch9": data["frKey"],
    		"srch10": data["tradeComNm"]
        };

	//console.log("globalSData", globalSData);
	
    fn_searchSettleDetailPopup(globalSData);
}


function fundSettleDetailListClose(){
	  // ë°ì´í„° ì´ˆê¸°í™” í›„ ëª¨ë‹¬ ë‹«ê¸° (ì•½ê°„ì˜ ë”œë ˆì´ ì¶”ê°€)
    fundSettleDetailHot.loadData([]);
    
    setTimeout(function() {
        $("#fundSettleDetailtPopUp").modal("hide");
    }, 50);
}


function fn_searchSettleDetailPopup(sData){
	fn_loading(true);
	 $.ajax({
			type : "POST",
			url : "/rpt/fundSettleDetailList.do",
			data : sData,
			beforeSend : function(xmlHttpRequest){
				xmlHttpRequest.setRequestHeader("AJAX", "true");
			},
			dataType : 'json',
			async: false,
	        success : function(data) {
	        	//console.log("data.resultList"+data.resultList);
	        	fundSettleDetailHot.loadData([]);
	        	fundSettleDetailHot.loadData(data.resultList);
				setTimeout(function() {fundSettleDetailHot.render()}, 50);
				fn_loading(false);
	        },
	        error : function(e, textStatus, errorThrown) {
	        	if(e.status == 400){
	        		alert("ì—ëŸ¬ ë°œìƒ");
	        		location.href = document.referrer;
	        	} else {
		        	console.log(errorThrown);
		        	alert(msgSearchError);
	        	}
	        }
		});
	}

//table
function fn_handsonGridCalOption(col, header, hidden){
	var tableType = $("input:radio[name=fundSettleType]:checked").val();
	
	fundSettleSettings = {
	  columns : col,
	  colHeaders : header,
	  hiddenColumns : {
    	  copyPasteEnabled : false,
    	  indicators : false,
    	  columns : hidden
      },
	  stretchH : 'all',
	  width : '100%',
	  autoWrapRow : true,
	  height : 550,
	  rowHeights : 25,
	  rowHeaders : true,
	  columnHeaderHeight : 25,
	  manualRowResize : true,
	  manualColumnResize : true,
	  manualRowMove : true,
	  manualColumnMove : false,
	  //dropdownMenu : true,
	  copyPaste: true, // ì—‘ì…€ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í™œì„±í™”
	  contextMenu : (tableType == "enrol") ? ['row_above', 'row_below', '---------', 'undo', 'redo', 'remove_row'] : false,
	  filters : true,
	  readOnly : (tableType == "read") ? true : false,
	  allowInsertRow : true,
	  allowRemoveRow : true,
	  columnSorting : {indicator : true},
      autoColumnSize : {samplingRatio : 23},
      ergeCells : false,
      wordWrap : true,
      afterGetColHeader: function(col, TH){
      	if(col == 0){
        	TH.innerHTML = "<input type='checkbox'  class='checker' id='id_checkCalculAll' onclick='fn_CalculAllClick();'>";
        }
      } ,
	};
	return fundSettleSettings;
}


function fn_handsonGridImpViewListPopupOption() {
	impViewListPopupSettings = {
columns: [
        	//{ data :'checkBox', type :'text', className :"htCenter", width: 30, type:'checkbox', checkedTemplate:'yes', uncheckedTemplate:'no', readOnly:false },
            { data: 'category', type: 'text', className: "htCenter" },
            {
                data: 'supplier',
                editor: 'select',  // select ë°•ìŠ¤ ì‚¬ìš©
                selectOptions: customDropdown, // ê¸°ë³¸ì ìœ¼ë¡œ customDropdownì„ ì‚¬ìš©
                className: "htCenter",
                renderer: function (instance, td, row, col, prop, value, cellProperties) {
                    // ê¸°ì¡´ ê°’ ìœ ì§€
                    Handsontable.renderers.TextRenderer.apply(this, arguments);
                }
            },
            //{ data: 'supplier', type: 'text', className: "htCenter", readOnly: true },
            { data: 'clearFee', type : 'numeric', className : "htRight", 	numericFormat : {pattern : '0,0'},className: "htCenter"},
            { data: 'taxVat', type : 'numeric',className : "htRight", 	numericFormat : {pattern : '0,0'}, className: "htCenter"},
            { data: 'sumEk', type : 'numeric', className : "htRight", 	numericFormat : {pattern : '0,0'},className: "htCenter"},
            { data: 'note', type : 'text', className: "htCenter"}
        ],
        stretchH: 'all',
        width: '100%',
        autoWrapRow: true,
        height: 250,
        rowHeights: 25,
        rowHeaders: true,
        columnHeaderHeight: 25,
        colHeaders: ["ë¹„ìš©ëª…", "ê³µê¸‰ì—…ì²´", "ê³µê¸‰ê°€", "ë¶€ê°€ì„¸", "í•©ê³„", "ë¹„ê³ "],
        manualRowResize: true,
        manualColumnResize: true,
        manualRowMove: true,
        manualColumnMove: false,
        contextMenu: false,
        dropdownMenu: false,
        contextMenu : ['row_above', 'row_below', '---------', 'undo', 'redo', 'remove_row'] ,
        filters: true,
        readOnly: false,
        columnSorting: { indicator: true },
        autoColumnSize: { samplingRatio: 23 },
        mergeCells: false,
        allowInsertRow: true,
        allowRemoveRow : true,
        // âœ… ê° í–‰ë§ˆë‹¤ category ê°’ì— ë”°ë¼ selectOptions ë™ì ìœ¼ë¡œ ì„¤ì •!
        cells: function (row, col, prop) {
            let cellProperties = {};

            if (prop === 'supplier') {
                // fundSettleDetailHotê°€ ì´ˆê¸°í™”ëœ í›„ì—ë§Œ getSourceDataAtRow í˜¸ì¶œ
                if (fundSettleDetailHot) {
                    // category ê°’ ê°€ì ¸ì˜¤ê¸° (null ë˜ëŠ” undefined ë°©ì§€)
                    let rowData = fundSettleDetailHot.getSourceDataAtRow(row);

                    // rowDataê°€ ìœ íš¨í•˜ë©´ category ê°’ì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
                    let categoryValue = rowData ? rowData.category : undefined;

                    //console.log(`ğŸ“Œ Row ${row} Category: ${categoryValue}`);

                    switch (categoryValue) {
                        case "ê´€ì„¸":
                        case "ë¶€ê°€ì„¸":
                            cellProperties.selectOptions = customDropdown;
                            break;
                        case "í•­ê³µìš´ì„":
                        case "í•­ê³µì‚¬ìˆ˜ìˆ˜ë£Œ":
                            cellProperties.selectOptions = forwordDropdown;
                            break;
                        case "ì°½ê³ ë£Œ":
                            cellProperties.selectOptions = warehouseDropdown;
                            break;
                        case "ë³´í—˜ë£Œ":
                            cellProperties.selectOptions = PremiumDropdown;
                            break;
                        case "ë‚´ë¥™ìš´ì†¡ë£Œ":
                            cellProperties.selectOptions = transportationDropdown;
                            break;
                        case "í†µê´€ìˆ˜ìˆ˜ë£Œ":
                            cellProperties.selectOptions = feeDropdown;
                            break;
                            
                        default:
                            cellProperties.selectOptions = masterDropdown;
                    }

                    //console.log(`âœ… Updated selectOptions for Row ${row}:`, cellProperties.selectOptions);
                } else {
                   // console.log("âŒ fundSettleDetailHot is not initialized yet.");
                }
            }

            return cellProperties;
        }
	};

    return impViewListPopupSettings;
}



//í…Œì´ë¸” íƒ€ì… ë³€ê²½
function fn_changeFundSettleView(type) {
    var searchTp = $("input:radio[name=fundSettleType]:checked").val();
    var radioTp = $("input:radio[name=fundSettle_srch1]:checked").val();

    if (radioTp == "01") {
    	if(searchTp == "read"){
    		 console.log("01 ì„ íƒë¨");
    	        $("#fundSettleExcelDown").show();
    	        $("#fundSettleSaveBtn").hide();
    	        $(".fundSettle_div3").show();
    	        $(".fundSettle_div4").show();
    	        $(".fundSettle_div5").hide();
    	        $(".fundSettle_div6").hide();
    	        $("#fundSettle_div1").show();
    	        $("#fundSettle_div2").show();
    	        $(".registerDay").show();
    	        $("#fundSettleEtcSaveBtn").hide();
    	}else {
    		console.log("1ì´ë‘ edit")
    		$("#fundSettleExcelDown").show();
	        $("#fundSettleSaveBtn").hide();
	        $(".fundSettle_div3").show();
	        $(".fundSettle_div4").show();
	        $(".fundSettle_div5").hide();
	        $(".fundSettle_div6").hide();
	        $("#fundSettle_div1").show();
	        $("#fundSettle_div2").show();
	        $(".registerDay").show();
	        $("#fundSettleEtcSaveBtn").show();
    	}
       
        
        fn_changefundSettleViewType(searchTp);
    } else if (radioTp == "02") {
        if (searchTp == "edit") {
            console.log("edit ëª¨ë“œ");
            $("#fundSettleExcelDown").hide();
            $("#fundSettleSaveBtn").show();
            $(".fundSettle_div3").hide();
            $(".fundSettle_div4").hide();
            $(".fundSettle_div5").show();
            $(".fundSettle_div6").show();
            $("#fundSettle_div1").hide();
            $("#fundSettle_div2").hide();
            $(".registerDay").hide();
            $("#fundSettleEtcSaveBtn").hide();
        } else if (searchTp == "enrol") {
            console.log("enrol ëª¨ë“œ");
            $("#fundSettleExcelDown").hide();
            $("#fundSettleSaveBtn").show();
            $(".fundSettle_div3").hide();
            $(".fundSettle_div4").hide();
            $(".fundSettle_div5").show();
            $(".fundSettle_div6").show();
            $("#fundSettle_div1").hide();
            $("#fundSettle_div2").hide();
            $(".registerDay").hide();
            $("#fundSettleEtcSaveBtn").hide();
        } else {
            console.log("read ëª¨ë“œ");
            fundSettleHot.updateSettings({ readOnly: true, contextMenu: false });
            $("#fundSettleExcelDown").hide();
            $("#fundSettleSaveBtn").hide();
            $(".fundSettle_div3").hide();
            $(".fundSettle_div4").hide();
            $(".fundSettle_div5").show();
            $(".fundSettle_div6").show();
            $("#fundSettle_div1").hide();
            $("#fundSettle_div2").hide();
            $(".registerDay").hide();
            $("#fundSettleEtcSaveBtn").hide();
        }
        fn_changefundSettleViewType(searchTp);
    }

};
//ìê¸ˆì •ì‚° ë””í…Œì¼ ì €ì¥ 
function fn_fundSettleDetailListSave(){
	   console.log("Saving data:", globalSData);
	   var detailData = fundSettleDetailHot.getSourceData();
	   var popData = [];
	   for(var i=0; i<detailData.length; i++){
		   popData.push(detailData[i])
	   }
	   
	   for (var i = 0; i < popData.length; i++) {
	        popData[i].rptNo = globalSData.srch1;
	        popData[i].blno = globalSData.srch2;
	        popData[i].frKey = globalSData.srch9;
	    }
	   
	   console.log("Updated popData:", popData);
	   $.ajax({
		   type : "POST",
			url : "/rpt/savefundSettleDetail.do",
			data : JSON.stringify(popData),
			beforeSend : function(xmlHttpRequest){
				xmlHttpRequest.setRequestHeader("AJAX", "true");
			},
			contentType: "application/json; charset=utf-8",
	        success : function(data) {
	            if(data.trim() === "success"){ 
	        		alert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
	        		fundSettleDetailListClose();
	        		fn_searchFundSettleViewInfo();
	        	}
	        	fn_loading(false);
	        },
	        error : function(e, textStatus, errorThrown) {
	        	if(e.status == 400){
	        		alert("Your request is up. Please log back in if you wish continue");
	        		location.href = document.referrer;
	        	} else {
		        	console.log(errorThrown);
		        	alert(msgSaveError);
	        	}
	        }
		});
}

//ë§ˆìŠ¤í„° í¸ì§‘ ì €ì¥ 
function fn_savefundSettleSave(){
	fn_loading(true);
	var editeData = fundSettleHot.getSourceData();
	var popData = [];
	for(var i=0; i<editeData.length; i++){
		popData.push(editeData[i]);
	}
	
	$.ajax({
		type : "POST",
		url : "/rpt/savefundSettle.do",
		data : JSON.stringify(popData),
		beforeSend : function(xmlHttpRequest){
			xmlHttpRequest.setRequestHeader("AJAX", "true");
		},
		contentType: "application/json; charset=utf-8",
        success : function(data) {
            if(data.trim() === "success"){ 
        		alert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        		$("input:radio[name=fundSettle_srch1][value='02']").prop("checked", true).trigger("click");
        		$("input:radio[name=fundSettleType][value='read']").prop("checked", true).trigger("click");
        		setTimeout(function() {
        		    fn_searchFundSettleViewInfo();  // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ í›„ ê²€ìƒ‰ ì‹¤í–‰
        		}, 100);
        	}
        	fn_loading(false);
        },
        error : function(e, textStatus, errorThrown) {
        	if(e.status == 400){
        		alert("Your request is up. Please log back in if you wish continue");
        		location.href = document.referrer;
        	} else {
	        	console.log(errorThrown);
	        	alert(msgSaveError);
        	}
        }
	});
}


//ê¸°íƒ€ì‚¬í•­ ì €ì¥ 
function fn_savefundSettleEtc(){
	fn_loading(true);
	var editeData = fundSettleHot.getSourceData();
	var popData = [];
	for(var i=0; i<editeData.length; i++){
		popData.push(editeData[i]);
	}
	
	$.ajax({
		type : "POST",
		url : "/rpt/savefundSettleEtc.do",
		data : JSON.stringify(popData),
		beforeSend : function(xmlHttpRequest){
			xmlHttpRequest.setRequestHeader("AJAX", "true");
		},
		contentType: "application/json; charset=utf-8",
        success : function(data) {
            if(data.trim() === "success"){ 
        		alert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        		$("input:radio[name=fundSettle_srch1][value='01']").prop("checked", true).trigger("click");
        		$("input:radio[name=fundSettleType][value='read']").prop("checked", true).trigger("click");
        		fn_changeFundSettleView();
        		setTimeout(function() {
        		    fn_searchFundSettleViewInfo();  // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ í›„ ê²€ìƒ‰ ì‹¤í–‰
        		}, 100);
        	}
        	fn_loading(false);
        },
        error : function(e, textStatus, errorThrown) {
        	if(e.status == 400){
        		alert("Your request is up. Please log back in if you wish continue");
        		location.href = document.referrer;
        	} else {
	        	console.log(errorThrown);
	        	alert(msgSaveError);
        	}
        }
	});
}


//ê²€ìƒ‰êµ¬ë¶„ ë³€ê²½
function fn_changefundSettleViewType(type){
	let fundSettleCol = new fn_fundSettleTableCol();
	let fundSettleHeader = new fn_fundSettleTableHeader();
	let fundSettleHidden = new fn_fundSettleTableHidden();
	
	var col, header, hidden, col2, header2, hidden2, col3, header3, hidden3 ;

	//fn_searchGridPurchOption(true);
	col = fundSettleCol.fundSettleCol;
	header = fundSettleHeader.fundSettleHeader;
	hidden = fundSettleHidden.fundSettleHidden;

	
	fundSettleHot.updateSettings(fn_handsonGridCalOption(col, header, hidden));

	var radioTp = $("input:radio[name=fundSettle_srch1]:checked").val();
	
	// ë§ˆìŠ¤í„°ê´€ë¦¬
	if(radioTp == '02'){
		console.log("ë§ˆìŠ¤í„°ê´€ë¦¬");
		$('input[name="fundSettleType"][value="enrol"]').parent().show(); 
		if(type == "read"){
			fn_searchFundSettleViewInfo();
			$("btnCalculateViewSave").hide();
			}if(type == 'enrol'){
				fundSettleHot.loadData([]);
				fundSettleHot.alter('insert_row_below', 1, 1);
				fn_loading(false);
			}if(type == 'edit'){
				//calculateDetailHot2.loadData([]);
				console.log("5");
				fn_searchFundSettleViewInfo();
			}
	//ìê¸ˆì •ì‚°
	}else if(radioTp == '01'){
		console.log("ìê¸ˆì •ì‚°");
	    if(type == "read"){
	        $('input[name="fundSettleType"][value="enrol"]').parent().hide();    // 'edit' ë¼ë””ì˜¤ ìˆ¨ê¸°ê¸°
	        
		    fn_searchFundSettleViewInfo();
	    }else if(type == "edit"){
	    	fn_searchFundSettleViewInfo();
	    }
	
		
	}
	//fn_searchFundSettleViewInfo();
	
	
};

//ì •ì‚°ì„œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ 
function fn_funcSettleExcelDownload(){
	fn_loading(true);
	var cnt1 = 0;
	var checkedData = fundSettleHot.getSourceData();
	var fundSettle = [];
	var fundSettle1 = [];
	var blno = "";
	 // ì²´í¬ë°•ìŠ¤ë¥¼ í™•ì¸
	 for (var i = 0; i < checkedData.length; i++) {
	        // ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
	        if (checkedData[i].checkBox === 'yes') {  // 'yes'ì¼ ê²½ìš° ì²´í¬ëœ í•­ëª©
	            fundSettle.push(checkedData[i]);  // í•´ë‹¹ í•­ëª©ì„ fundSettleì— ì¶”ê°€
	            fundSettle1.push({ blno: checkedData[i].hawb}); 
	            cnt1++;  // ì²´í¬ëœ í•­ëª© ê°œìˆ˜ ì¦ê°€
	        }
	    }

	    //console.log("ì²´í¬ëœ í•­ëª© ê°œìˆ˜:", cnt1); // ì²´í¬ëœ í•­ëª© ê°œìˆ˜ í™•ì¸
	    //console.log("blno:", blno); // ì²´í¬ëœ í•­ëª© ê°œìˆ˜ í™•ì¸
    
    // ì²´í¬ëœ í•­ëª©ì´ 1ê°œ ì´ìƒì¼ ê²½ìš° alertì„ ë„ì›€
    /*if (cnt1 > 1) {
        alert("ì •ì‚°ì„œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œëŠ” 1ê°œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return false;
    }  else*/ 
	 if((cnt1 == 0)){
        alert("ì •ì‚°ì„œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ ìµœì†Œ 1ê°œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        return false;
    }
    
    console.log("fundSettle",fundSettle);
    console.log("fundSettle1",fundSettle1);
    
   $.ajax({
    	type : "POST",
    	url :"/rpt/excelFundSettle.do",
    	data : JSON.stringify(fundSettle),
		beforeSend : function(xmlHttpRequest){
			xmlHttpRequest.setRequestHeader("AJAX", "true");
		},
		contentType: "application/json; charset=utf-8",
		async : false,
		success : function(data, textStatus, jqXHR) {
			console.log("ì„œë²„ì‘ë‹´:",data);
			if(data == "success"){
				fn_downloadSettleDO(fundSettle1);
			} else {
				alert("ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
			}
			fn_loading(false);
		},
	
		error : function(e, textStatus, errorThrown) {
			if(e.status == 400){
				alert("Your request is up. Please log back in if you wish continue");
				location.href = document.referrer;
			} else { 
				console.log(errorThrown);
				alert(msgSearchError);
			}
		}
    });
	
}

function fn_downloadSettleDO(blno){
	 if (!Array.isArray(blno)) {
	        // âœ… ë‹¨ì¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
	     console.log("1");  
		 window.location.href = "/rpt/downloadSettle.do?blno=" + encodeURIComponent(blno);
	     return;
	     fn_searchFundSettleViewInfo(); 
	    }
	    if (blno.length === 1) {
	    	 console.log("2");  
	        // âœ… ì²´í¬í•œ í•­ëª©ì´ 1ê°œë©´ ê¸°ì¡´ ë°©ì‹ ìœ ì§€
	        window.location.href = "/rpt/downloadSettle.do?blno=" + encodeURIComponent(blno[0].blno);
	        fn_searchFundSettleViewInfo();
	    } else {
	        // âœ… ì—¬ëŸ¬ ê°œ ì„ íƒí•˜ë©´ ZIPìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ (Ajax ë°©ì‹)
	    	
	    	var fundSettle = blno.map(item => item.blno);

	        console.log("ğŸ“Œ ZIP ë‹¤ìš´ë¡œë“œ ìš”ì²­ - blno ëª©ë¡:", fundSettle);

	        $.ajax({
	            type: "POST",
	            url: "/rpt/downloadSettleZip.do",
	            data: JSON.stringify(fundSettle),
	            beforeSend: function (xmlHttpRequest) {
	                xmlHttpRequest.setRequestHeader("AJAX", "true");
	            },
	            contentType: "application/json; charset=utf-8",
	            xhrFields: {
	                responseType: "blob"
	            },
	            success: function (data, textStatus, xhr) {
	            	  // âœ… ì„œë²„ì—ì„œ ë°›ì€ íŒŒì¼ ì´ë¦„ì„ í—¤ë”ì—ì„œ ê°€ì ¸ì˜¤ê¸°
	                var zipFileName = xhr.getResponseHeader("Zip-File-Name");

	                if (!zipFileName) {
	                    console.error("âŒ Zip-File-Name í—¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤.");
	                    return;
	                }

	                zipFileName = decodeURIComponent(zipFileName); // í•œê¸€ íŒŒì¼ëª… ê¹¨ì§ ë°©ì§€

	                console.log("ğŸ“Œ ë°›ì€ íŒŒì¼ ì´ë¦„:", zipFileName);

	                var blob = new Blob([data], { type: "application/zip" });
	                var link = document.createElement("a");
	                link.href = window.URL.createObjectURL(blob);
	                link.download = zipFileName;  // í—¤ë”ì—ì„œ ë°›ì€ íŒŒì¼ ì´ë¦„ ì‚¬ìš©

	                document.body.appendChild(link);
	                link.click();
	                document.body.removeChild(link);
	                fn_searchFundSettleViewInfo();
	            },
	            error: function () {
	                alert("ZIP ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
	            }
	        });
	    }
};


